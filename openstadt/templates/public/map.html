{% extends "map_layout.html" %}

{% block title %}{{ city.name }} - OpenStadt{% endblock %}
{% block description %}Offene Stadtdaten für {{ city.name }}{% endblock %}
{% block city_name %}{{ city.name }}{% endblock %}

{% block content %}
<v-app>
    <!-- Map Container -->
    <div id="map-container" class="map-container">
    <!-- Layer Control Panel -->
    <div class="layer-panel" :class="{ 'panel-collapsed': !showLayerPanel }">
        <div class="panel-header" @click="showLayerPanel = !showLayerPanel">
            <v-icon icon="mdi-layers"></v-icon>
            <span v-if="showLayerPanel">Ebenen</span>
            <v-spacer></v-spacer>
            <v-icon :icon="showLayerPanel ? 'mdi-chevron-left' : 'mdi-chevron-right'"></v-icon>
        </div>

        <div v-if="showLayerPanel" class="panel-content">
            <!-- District Filter -->
            <v-select
                v-if="districts.length > 0"
                v-model="selectedDistrict"
                :items="districtOptions"
                label="Stadtteil"
                density="compact"
                variant="outlined"
                clearable
                hide-details
                class="mb-3"
            ></v-select>

            <div v-for="layer in layers" :key="layer.id" class="layer-item">
                <label class="layer-checkbox">
                    <input
                        type="checkbox"
                        :value="layer.slug"
                        :checked="visibleLayers.includes(layer.slug)"
                        @change="toggleLayer(layer.slug, $event.target.checked)"
                        class="layer-checkbox-input"
                    >
                    <span class="layer-checkbox-box" :style="{ '--layer-color': layer.color }"></span>
                    <span class="layer-dot" :style="{ backgroundColor: layer.color }"></span>
                    <span class="layer-name">${ layer.name }</span>
                    <span class="layer-count">${ layer.poiCount || 0 }</span>
                </label>
            </div>

            <!-- POI Counter -->
            <div class="poi-counter mt-3">
                <v-icon size="small" icon="mdi-map-marker-multiple"></v-icon>
                <span>${ visiblePoiCount } sichtbar</span>
            </div>
        </div>
    </div>

    <!-- City Switcher -->
    <div class="city-switcher">
        <select class="city-select" @change="switchCity($event.target.value)" :value="city.slug">
            <option v-for="c in allCities" :key="c.slug" :value="c.slug">${ c.name }</option>
        </select>
    </div>

    <!-- Search -->
    <div class="search-container">
        <v-text-field
            v-model="searchQuery"
            placeholder="Suche..."
            prepend-inner-icon="mdi-magnify"
            variant="solo"
            density="compact"
            hide-details
            clearable
            @input="debouncedSearch"
            @click:clear="clearSearch"
        ></v-text-field>

        <v-card v-if="searchResults.length > 0" class="search-results">
            <v-list density="compact">
                <v-list-item
                    v-for="poi in searchResults"
                    :key="poi.id"
                    @click="selectPoi(poi)"
                >
                    <template v-slot:prepend>
                        <span class="layer-dot" :style="{ backgroundColor: getLayerColor(poi.layerId) }"></span>
                    </template>
                    <v-list-item-title>${ poi.name }</v-list-item-title>
                    <v-list-item-subtitle>${ poi.address || poi.district }</v-list-item-subtitle>
                </v-list-item>
            </v-list>
        </v-card>
    </div>

    <!-- Location Button -->
    <v-btn
        class="location-btn"
        icon
        size="small"
        @click="locateUser"
        :loading="locating"
    >
        <v-icon icon="mdi-crosshairs-gps"></v-icon>
    </v-btn>

    <!-- Analytics Button -->
    <v-btn
        class="analytics-btn"
        :href="'/' + city.slug + '/analytics'"
        icon
        size="small"
        color="primary"
    >
        <v-icon icon="mdi-chart-bar"></v-icon>
        <v-tooltip activator="parent" location="left">Analyse Dashboard</v-tooltip>
    </v-btn>

    <!-- The Map -->
    <div id="map"></div>

    <!-- POI Detail Panel -->
    <v-navigation-drawer
        v-model="showPoiDetail"
        location="right"
        width="360"
        :permanent="showPoiDetail"
        class="poi-drawer"
    >
        <div v-if="selectedPoi" @click.stop>
            <!-- Header with layer color -->
            <v-toolbar :color="getLayerColor(selectedPoi.layerId)" density="compact">
                <v-toolbar-title class="text-white">${ selectedPoi.name }</v-toolbar-title>
                <v-btn icon @click.stop="showPoiDetail = false" color="white">
                    <v-icon icon="mdi-close"></v-icon>
                </v-btn>
            </v-toolbar>

            <!-- Layer badge -->
            <div class="pa-3 bg-grey-lighten-4 d-flex align-center justify-space-between">
                <div>
                    <v-chip :color="getLayerColor(selectedPoi.layerId)" size="small" label>
                        ${ getLayerName(selectedPoi.layerId) }
                    </v-chip>
                    <span class="text-caption text-grey ml-2">
                        ${ getLayerPoiIndex(selectedPoi) } von ${ getLayerPoiCount(selectedPoi.layerId) }
                    </span>
                </div>
                <v-btn icon size="small" variant="text" @click.stop="sharePoi">
                    <v-icon icon="mdi-share-variant" size="small"></v-icon>
                    <v-tooltip activator="parent" location="bottom">Teilen</v-tooltip>
                </v-btn>
            </div>

            <!-- Location info - always show -->
            <v-card flat class="ma-3 pa-3" style="background: #E3F2FD; border: 2px solid #1976D2;">
                <div class="d-flex align-center mb-2" v-if="selectedPoi.address && selectedPoi.address.trim()">
                    <v-icon icon="mdi-map-marker" color="primary" class="mr-2" size="small"></v-icon>
                    <div class="font-weight-medium">${ selectedPoi.address }</div>
                </div>
                <div class="d-flex align-center mb-2" v-if="selectedPoi.district">
                    <v-icon icon="mdi-home-city" color="primary" class="mr-2" size="small"></v-icon>
                    <div>Stadtteil: <strong>${ selectedPoi.district }</strong></div>
                </div>
                <div class="d-flex align-center">
                    <v-icon icon="mdi-crosshairs-gps" color="primary" class="mr-2" size="small"></v-icon>
                    <div class="text-caption">${ selectedPoi.lat.toFixed(5) }, ${ selectedPoi.lng.toFixed(5) }</div>
                </div>
            </v-card>

            <!-- Quick facts for common attributes -->
            <div class="px-3" v-if="hasQuickFacts(selectedPoi)">
                <div class="d-flex flex-wrap ga-2 mb-3">
                    <v-chip v-if="getAttr(selectedPoi, 'wheelchair') === 'yes'" size="small" color="success" variant="tonal">
                        <v-icon start icon="mdi-wheelchair" size="small"></v-icon> Barrierefrei
                    </v-chip>
                    <v-chip v-if="getAttr(selectedPoi, 'wheelchair') === 'no'" size="small" color="error" variant="tonal">
                        <v-icon start icon="mdi-wheelchair" size="small"></v-icon> Nicht barrierefrei
                    </v-chip>
                    <v-chip v-if="getAttr(selectedPoi, 'lit') === 'yes'" size="small" color="amber" variant="tonal">
                        <v-icon start icon="mdi-lightbulb" size="small"></v-icon> Beleuchtet
                    </v-chip>
                    <v-chip v-if="getAttr(selectedPoi, 'fee') === 'no' || getAttr(selectedPoi, 'fee') === 'no'" size="small" color="success" variant="tonal">
                        <v-icon start icon="mdi-currency-eur-off" size="small"></v-icon> Kostenlos
                    </v-chip>
                    <v-chip v-if="getAttr(selectedPoi, 'surface')" size="small" variant="tonal">
                        <v-icon start icon="mdi-texture" size="small"></v-icon> ${ formatValue(getAttr(selectedPoi, 'surface')) }
                    </v-chip>
                    <v-chip v-if="getAttr(selectedPoi, 'operator')" size="small" variant="tonal">
                        <v-icon start icon="mdi-domain" size="small"></v-icon> ${ getAttr(selectedPoi, 'operator') }
                    </v-chip>
                </div>
            </div>

            <!-- Detailed Attributes -->
            <v-expansion-panels v-if="Object.keys(filteredAttributes(selectedPoi)).length > 0" variant="accordion" class="mx-3 mb-3">
                <v-expansion-panel>
                    <v-expansion-panel-title class="text-body-2">
                        <v-icon icon="mdi-database" size="small" class="mr-2"></v-icon>
                        Alle Details (${ Object.keys(filteredAttributes(selectedPoi)).length })
                    </v-expansion-panel-title>
                    <v-expansion-panel-text>
                        <v-list density="compact" class="pa-0">
                            <template v-for="(value, key) in filteredAttributes(selectedPoi)" :key="key">
                                <v-list-item v-if="value" class="px-0">
                                    <v-list-item-subtitle class="text-caption">${ formatLabel(key) }</v-list-item-subtitle>
                                    <v-list-item-title class="text-body-2">${ formatValue(value) }</v-list-item-title>
                                </v-list-item>
                            </template>
                        </v-list>
                    </v-expansion-panel-text>
                </v-expansion-panel>
            </v-expansion-panels>

            <!-- Data source note -->
            <div class="mx-3 mb-3 pa-2 rounded text-caption text-grey" style="background: #F5F5F5;">
                <v-icon icon="mdi-database-outline" size="x-small" class="mr-1"></v-icon>
                Daten: OpenStreetMap
                <span v-if="selectedPoi.sourceId"> · ID: ${ selectedPoi.sourceId }</span>
            </div>

            <!-- Action buttons -->
            <div class="pa-3 d-flex ga-2">
                <v-btn
                    :href="'https://www.google.com/maps/dir/?api=1&destination=' + selectedPoi.lat + ',' + selectedPoi.lng"
                    target="_blank"
                    prepend-icon="mdi-directions"
                    color="primary"
                    variant="elevated"
                    size="small"
                    @click.stop
                >
                    Route
                </v-btn>
                <v-btn
                    :href="'https://www.openstreetmap.org/?mlat=' + selectedPoi.lat + '&mlon=' + selectedPoi.lng + '&zoom=18'"
                    target="_blank"
                    prepend-icon="mdi-map"
                    variant="outlined"
                    size="small"
                    @click.stop
                >
                    OSM
                </v-btn>
                <v-btn
                    v-if="selectedPoi.sourceId"
                    :href="'https://www.openstreetmap.org/node/' + selectedPoi.sourceId"
                    target="_blank"
                    prepend-icon="mdi-pencil"
                    variant="text"
                    size="small"
                    @click.stop
                >
                    Bearbeiten
                </v-btn>
            </div>
        </div>
    </v-navigation-drawer>
</div>
</v-app>
{% endblock %}

{% block js %}
<script>
    const cityData = {{ city.to_dict(include_layers=True) | tojson | safe }};
    const allCitiesData = {{ all_cities | tojson | safe }};

    const { createApp } = Vue;
    const { createVuetify } = Vuetify;
    const vuetify = createVuetify(config.vuetifyConfig);

    const app = createApp({
        delimiters: config.delimiters,
        data() {
            return {
                city: cityData,
                allCities: allCitiesData,
                selectedCity: cityData.slug,
                layers: cityData.layers || [],
                visibleLayers: cityData.layers
                    ?.filter(l => l.visibleByDefault)
                    .map(l => l.slug) || [],
                pois: [],
                districts: [],
                selectedDistrict: null,
                markers: {},
                markerCluster: null,
                map: null,
                searchQuery: '',
                searchResults: [],
                selectedPoi: null,
                showPoiDetail: false,
                showLayerPanel: true,
                locating: false,
                searchTimeout: null,
            };
        },
        computed: {
            districtOptions() {
                return this.districts.map(d => ({ title: d, value: d }));
            },
            visiblePoiCount() {
                return this.pois.filter(poi => {
                    const layer = this.layers.find(l => l.id === poi.layerId);
                    if (!layer || !this.visibleLayers.includes(layer.slug)) return false;
                    if (this.selectedDistrict && poi.district !== this.selectedDistrict) return false;
                    return true;
                }).length;
            }
        },
        watch: {
            visibleLayers: {
                handler() {
                    this.updateMarkers();
                },
                deep: true
            },
            selectedDistrict() {
                this.updateMarkers();
            }
        },
        methods: {
            initMap() {
                this.map = L.map('map', {
                    zoomControl: true,
                }).setView(this.city.center, this.city.defaultZoom);

                L.tileLayer(leafletConfig.tileLayer, {
                    attribution: leafletConfig.tileAttribution,
                    maxZoom: leafletConfig.maxZoom,
                }).addTo(this.map);

                // Initialize marker cluster
                this.markerCluster = L.markerClusterGroup({
                    maxClusterRadius: 50,
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: false,
                });
                this.map.addLayer(this.markerCluster);

                this.loadPois();
            },

            async loadPois() {
                try {
                    const response = await axios.get(`/api/v1/cities/${this.city.slug}/pois?per_page=5000`);
                    this.pois = response.data.items;
                    // Extract unique districts
                    this.districts = [...new Set(this.pois.map(p => p.district).filter(Boolean))].sort();
                    this.updateMarkers();
                } catch (error) {
                    console.error('Error loading POIs:', error);
                }
            },

            updateMarkers() {
                this.markerCluster.clearLayers();

                const visiblePois = this.pois.filter(poi => {
                    const layer = this.layers.find(l => l.id === poi.layerId);
                    if (!layer || !this.visibleLayers.includes(layer.slug)) return false;
                    if (this.selectedDistrict && poi.district !== this.selectedDistrict) return false;
                    return true;
                });

                visiblePois.forEach(poi => {
                    const layer = this.layers.find(l => l.id === poi.layerId);
                    const marker = L.circleMarker([poi.lat, poi.lng], {
                        radius: 9,
                        fillColor: layer?.color || '#DD0000',
                        color: '#000',
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 0.9,
                    });

                    marker.bindTooltip(poi.name, { direction: 'top', offset: [0, -10] });
                    marker.on('click', () => this.selectPoi(poi));
                    this.markerCluster.addLayer(marker);
                    this.markers[poi.id] = marker;
                });
            },

            selectPoi(poi) {
                this.selectedPoi = poi;
                this.showPoiDetail = true;
                this.searchResults = [];
                this.searchQuery = '';

                if (this.map) {
                    this.map.setView([poi.lat, poi.lng], 16);
                }
            },

            getLayerColor(layerId) {
                const layer = this.layers.find(l => l.id === layerId);
                return layer?.color || '#3388ff';
            },

            getLayerName(layerId) {
                const layer = this.layers.find(l => l.id === layerId);
                return layer?.name || 'Unbekannt';
            },

            getLayerPoiCount(layerId) {
                return this.pois.filter(p => p.layerId === layerId).length;
            },

            getLayerPoiIndex(poi) {
                const layerPois = this.pois.filter(p => p.layerId === poi.layerId);
                return layerPois.findIndex(p => p.id === poi.id) + 1;
            },

            formatLabel(key) {
                return key.replace(/_/g, ' ').replace(/:/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            },

            formatValue(value) {
                if (typeof value === 'boolean') return value ? 'Ja' : 'Nein';
                if (value === 'yes') return 'Ja';
                if (value === 'no') return 'Nein';
                return value;
            },

            // Filter out redundant OSM tags
            filteredAttributes(poi) {
                if (!poi?.attributes) return {};
                const skipKeys = [
                    'amenity', 'leisure', 'natural', 'shop', 'tourism', 'building',
                    'access', 'source', 'created_by', 'type', 'man_made',
                    'addr:city', 'addr:country', 'addr:postcode',
                    'wheelchair', 'lit', 'fee', 'surface', 'operator'
                ];
                const result = {};
                for (const [key, value] of Object.entries(poi.attributes)) {
                    if (!skipKeys.includes(key) && value && value !== 'yes' && value !== 'no') {
                        result[key] = value;
                    }
                }
                return result;
            },

            getAttr(poi, key) {
                return poi?.attributes?.[key] || null;
            },

            hasQuickFacts(poi) {
                if (!poi?.attributes) return false;
                const quickKeys = ['wheelchair', 'lit', 'fee', 'surface', 'operator'];
                return quickKeys.some(k => poi.attributes[k]);
            },

            sharePoi() {
                const url = `${window.location.origin}/${this.city.slug}/poi/${this.selectedPoi.id}`;
                if (navigator.share) {
                    navigator.share({
                        title: this.selectedPoi.name,
                        text: `${this.selectedPoi.name} - ${this.getLayerName(this.selectedPoi.layerId)}`,
                        url: url
                    });
                } else {
                    navigator.clipboard.writeText(url);
                    alert('Link kopiert!');
                }
            },

            debouncedSearch() {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => this.search(), 300);
            },

            async search() {
                if (this.searchQuery.length < 2) {
                    this.searchResults = [];
                    return;
                }

                try {
                    const response = await axios.get(
                        `/api/v1/cities/${this.city.slug}/search?q=${encodeURIComponent(this.searchQuery)}`
                    );
                    this.searchResults = response.data.items;
                } catch (error) {
                    console.error('Search error:', error);
                }
            },

            clearSearch() {
                this.searchQuery = '';
                this.searchResults = [];
            },

            switchCity(slug) {
                if (slug && slug !== this.city.slug) {
                    window.location.assign('/' + slug);
                }
            },

            toggleLayer(slug, checked) {
                if (checked) {
                    if (!this.visibleLayers.includes(slug)) {
                        this.visibleLayers.push(slug);
                    }
                } else {
                    const index = this.visibleLayers.indexOf(slug);
                    if (index > -1) {
                        this.visibleLayers.splice(index, 1);
                    }
                }
            },

            locateUser() {
                if (!navigator.geolocation) return;

                this.locating = true;
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        this.map.setView([latitude, longitude], 15);
                        L.marker([latitude, longitude], {
                            icon: L.divIcon({
                                className: 'user-location-marker',
                                html: '<div class="pulse"></div>',
                                iconSize: [20, 20],
                            })
                        }).addTo(this.map);
                        this.locating = false;
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        this.locating = false;
                    }
                );
            }
        },
        mounted() {
            this.initMap();
        }
    });

    app.use(vuetify).mount('#app');
</script>
{% endblock %}
